<!DOCTYPE html>
<html>
  <head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular.js"></script>
    <script> 

      angular.module('rafflrUtils', []).service('rUtils', function(){
        // This function returns a random value from an array writing it this way
        // allows it to be more of a utility function.
        this.getRandomIndexValue = function(array){
          return array[Math.floor((Math.random() * array.length) )];
        };

        //This function returns true if the value exits in the array whether ot not 
        //case matches. If it does not match it returns false.
        this.containsValueIncaseSenitive = function(array, value){
          var testArray = [];
          array.forEach(function(oldValue){
            testArray.push(oldValue.toLowerCase());
          });
          //return the boolean result of this computation
          return testArray.indexOf(value.toLowerCase()) > -1;
        }
      });

      angular.module('rafflr', ['rafflrUtils'])
        .controller('rafflrController', ['$scope','rUtils', function($scope,rUtils){
          //attach names to scope
          $scope.names = ["John", "Jeff", "Jack"];
          $scope.userName = "";
          $scope.newName = "";

        }]).directive('chooseWinner',['rUtils', function(rUtils){
          // Runs during compile
          return {
            // name: '',
            // priority: 1,
            // terminal: true,
            // scope: {}, // {} = isolate, true = child, false/undefined = no change
            // controller: function($scope, $element, $attrs, $transclude) {},
            // require: 'ngModel', // Array = multiple requires, ? = optional, ^ = check parent elements
            restrict: 'E', // E = Element, A = Attribute, C = Class, M = Comment
            template: '<div class="container"> '+
                      '  <label for="name">Type in one of the following:'+
                      '    <sapn ng-repeat="name in names">'+
                      '      <span ng-if="!$last"> {{name}}, </span>'+
                      '      <span ng-if="$last">or {{name}}.</span>'+
                      '    </sapn>'+
                      '  </label><br/><br/>'+
                      '  <input type="text" id="name" class="form-control" ng-model="userName">'+
                      '  <br/>'+
                      '  <input type="button" class="btn btn-primary" value="Submit" ng-click="validateMatchFunction()">'+
                      '</div>',
            // templateUrl: '',
            // replace: true,
            // transclude: true,
            // compile: function(tElement, tAttrs, function transclude(function(scope, cloneLinkingFn){ return function linking(scope, elm, attrs){}})),
            link: function($scope, iElm, iAttrs, controller) {
              //function that gets called when submit is clicked
              $scope.validateMatchFunction = function(){
                var randomName = rUtils.getRandomIndexValue($scope.names);

                //notify user of chosen name
                alert("Random Name Choosen was "+randomName);

                //nested if statement to check if input was valid and then checking if it was a match
                if(rUtils.containsValueIncaseSenitive($scope.names, $scope.userName)){
                  if ($scope.userName.toLowerCase()===randomName.toLowerCase()){
                    alert("It's a match!");
                  } 
                  else {
                    alert("It's not a match.");
                  }
                }else{
                  alert("You cannot submit "+ $scope.userName);
                }
              } 
            }
          };
        }]).directive('addContestant',['rUtils', function(rUtils){
          // Runs during compile
          return {
            // name: '',
            // priority: 1,
            // terminal: true,
            // scope: {}, // {} = isolate, true = child, false/undefined = no change
            // controller: function($scope, $element, $attrs, $transclude) {},
            // require: 'ngModel', // Array = multiple requires, ? = optional, ^ = check parent elements
            restrict: 'E', // E = Element, A = Attribute, C = Class, M = Comment
            template: '<div class="container"> '+
                      '  <label for="name">Add new Name</label><br/><br/>'+
                      '  <input type="text" id="name" class="form-control" ng-model="newName">'+
                      '  <br/>'+
                      '  <input type="button" class="btn btn-primary" value="Add Name" ng-click="addNewName(newName)">'+
                      '</div>',
            // templateUrl: '',
            // replace: true,
            // transclude: true,
            // compile: function(tElement, tAttrs, function transclude(function(scope, cloneLinkingFn){ return function linking(scope, elm, attrs){}})),
            link: function($scope, iElm, iAttrs, controller) {
              $scope.addNewName = function(name){
                // TODO: allow this functionality to be controlled by the raffle admin
                if(rUtils.containsValueIncaseSenitive($scope.names, name)){
                  return alert('This name is already entered.');
                }
                $scope.names.push(name);
              }
            }
          };
        }]);

    </script>

  </head>
  
  <body ng-app="rafflr" ng-controller="rafflrController">
    <choose-winner></choose-winner>
    <add-contestant></add-contestant>
  </body>

</html>
