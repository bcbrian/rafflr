<!DOCTYPE html>
<html>
  <head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular.js"></script>
    <script> 

      angular.module('rafflrUtils', []).service('rUtils', function(){
        // This function returns a random value from an array writing it this way
        // allows it to be more of a utility function.
        this.getRandomIndexValue = function(array){
          return array[Math.floor((Math.random() * array.length) )];
        };

        //This function returns true if the value exits in the array whether ot not 
        //case matches. If it does not match it returns false.
        this.containsValueIncaseSenitive = function(array, value){
          var testArray = [];
          array.forEach(function(oldValue){
            testArray.push(oldValue.toLowerCase());
          });
          //return the boolean result of this computation
          return testArray.indexOf(value.toLowerCase()) > -1;
        };

        //This function tests a string to see if it looks like an email.
        this.validateEmail = function (email) {
          var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
          return re.test(email);
        };
      });

      angular.module('rafflr', ['rafflrUtils'])
        .controller('rafflrController', ['$scope','rUtils', function($scope,rUtils){
          //attach emails to scope
          $scope.emails = [];
          $scope.userEmail = "";
          $scope.newEmail = "";

          //function that gets called when submit is clicked
          $scope.validateMatchFunction = function(){
            var randomEmail = rUtils.getRandomIndexValue($scope.emails);

            //notify user of chosen name
            alert("Random Name Choosen was "+randomEmail);

            //nested if statement to check if input was valid and then checking if it was a match
            if(rUtils.containsValueIncaseSenitive($scope.emails, $scope.userEmail)){
              if ($scope.userEmail.toLowerCase()===randomEmail.toLowerCase()){
                alert("It's a match!");
              } 
              else {
                alert("It's not a match.");
              }
            }else{
              alert("You cannot submit "+ $scope.userEmail);
            }
          };

          $scope.addNewEmail = function(email){
            // TODO: allow this functionality to be controlled by the raffle admin
            if(!rUtils.validateEmail(email)){
              return alert('This "'+email+'" is not a valid email.');
            }
            if(rUtils.containsValueIncaseSenitive($scope.emails, email)){
              return alert('This email is already entered.');
            }
            $scope.emails.push(email);
          };
        }]).directive('chooseWinner', function(){
          // Runs during compile
          return {
            // name: '',
            // priority: 1,
            // terminal: true,
            // scope: {}, // {} = isolate, true = child, false/undefined = no change
            // controller: function($scope, $element, $attrs, $transclude) {},
            // require: 'ngModel', // Array = multiple requires, ? = optional, ^ = check parent elements
            restrict: 'E', // E = Element, A = Attribute, C = Class, M = Comment
            template: '<div class="container"> '+
                      '  <label for="email">Type in one of the following:'+
                      '    <sapn ng-repeat="email in emails">'+
                      '      <span ng-if="!$last"> {{email}}, </span>'+
                      '      <span ng-if="$last">or {{email}}.</span>'+
                      '    </sapn>'+
                      '  </label><br/><br/>'+
                      '  <input type="text" id="email" class="form-control" ng-model="userEmail">'+
                      '  <br/>'+
                      '  <input type="button" class="btn btn-primary" value="Submit" ng-click="validateMatchFunction()">'+
                      '</div>',
            // templateUrl: '',
            // replace: true,
            // transclude: true,
            // compile: function(tElement, tAttrs, function transclude(function(scope, cloneLinkingFn){ return function linking(scope, elm, attrs){}})),
            link: function($scope, iElm, iAttrs, controller) {
              
            }
          };
        }).directive('addContestant', function(){
          // Runs during compile
          return {
            // name: '',
            // priority: 1,
            // terminal: true,
            // scope: {}, // {} = isolate, true = child, false/undefined = no change
            // controller: function($scope, $element, $attrs, $transclude) {},
            // require: 'ngModel', // Array = multiple requires, ? = optional, ^ = check parent elements
            restrict: 'E', // E = Element, A = Attribute, C = Class, M = Comment
            template: '<div class="container"> '+
                      '  <label for="name">Add new Email</label><br/><br/>'+
                      '  <input type="type" id="name" class="form-control" ng-model="newEmail">'+
                      '  <br/>'+
                      '  <input type="button" class="btn btn-primary" value="Add Email" ng-click="addNewEmail(newEmail)">'+
                      '</div>',
            // templateUrl: '',
            // replace: true,
            // transclude: true,
            // compile: function(tElement, tAttrs, function transclude(function(scope, cloneLinkingFn){ return function linking(scope, elm, attrs){}})),
            link: function($scope, iElm, iAttrs, controller) {
              
            }
          };
        });

    </script>

  </head>
  
  <body ng-app="rafflr" ng-controller="rafflrController">
    <choose-winner></choose-winner>
    <add-contestant></add-contestant>
  </body>

</html>
